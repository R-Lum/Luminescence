<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Luminescence Emission Spectra Deconvolution — fit_EmissionSpectra • Luminescence</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Luminescence Emission Spectra Deconvolution — fit_EmissionSpectra"><meta name="description" content="Luminescence spectra deconvolution on RLum.Data.Spectrum and matrix objects
on an energy scale. The function is optimised for emission spectra typically
obtained in the context of TL, OSL and RF measurements detected between 200 and 1000 nm.
The function is not prepared to deconvolve TL curves (counts against temperature;
no wavelength scale). If you are interested in such analysis, please check, e.g.,
the package 'tgcd'."><meta property="og:description" content="Luminescence spectra deconvolution on RLum.Data.Spectrum and matrix objects
on an energy scale. The function is optimised for emission spectra typically
obtained in the context of TL, OSL and RF measurements detected between 200 and 1000 nm.
The function is not prepared to deconvolve TL curves (counts against temperature;
no wavelength scale). If you are interested in such analysis, please check, e.g.,
the package 'tgcd'."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Luminescence</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.25</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> Home</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">References</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="../news/index.html"><span class="fa fa-newspaper-o"></span> News</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/R-Lum/Luminescence"><span class="fa fa-github"></span> GitHub</a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Luminescence Emission Spectra Deconvolution</h1>
      <small class="dont-index">Source: <a href="https://github.com/R-Lum/Luminescence/blob/HEAD/R/fit_EmissionSpectra.R" class="external-link"><code>R/fit_EmissionSpectra.R</code></a></small>
      <div class="d-none name"><code>fit_EmissionSpectra.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Luminescence spectra deconvolution on <a href="RLum.Data.Spectrum-class.html">RLum.Data.Spectrum</a> and <a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a> objects
on an <strong>energy scale</strong>. The function is optimised for emission spectra typically
obtained in the context of TL, OSL and RF measurements detected between 200 and 1000 nm.
The function is not prepared to deconvolve TL curves (counts against temperature;
no wavelength scale). If you are interested in such analysis, please check, e.g.,
the package <code>'tgcd'</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fit_EmissionSpectra</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  frame <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n_components <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  start_parameters <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sub_negative <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  input_scale <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  method_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p><a href="RLum.Data.Spectrum-class.html">RLum.Data.Spectrum</a>, <a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a> (<strong>required</strong>): input
object. Please note that an energy spectrum is expected</p></dd>


<dt id="arg-frame">frame<a class="anchor" aria-label="anchor" href="#arg-frame"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a> (<em>optional</em>): defines the frame to be analysed</p></dd>


<dt id="arg-n-components">n_components<a class="anchor" aria-label="anchor" href="#arg-n-components"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a> (<em>optional</em>): allows a number of the aimed number of
components. However, it defines rather a maximum than than a minimum. Can be combined with
other parameters.</p></dd>


<dt id="arg-start-parameters">start_parameters<a class="anchor" aria-label="anchor" href="#arg-start-parameters"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a> (<em>optional</em>): allows to provide own start parameters for a
semi-automated procedure. Parameters need to be provided in eV. Every value provided replaces a
value from the automated peak finding algorithm (in ascending order).</p></dd>


<dt id="arg-sub-negative">sub_negative<a class="anchor" aria-label="anchor" href="#arg-sub-negative"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a> (<em>with default</em>): substitute negative values in the input object
by the number provided here (default: <code>0</code>). Can be set to <code>NULL</code>, i.e. negative values are kept.</p></dd>


<dt id="arg-input-scale">input_scale<a class="anchor" aria-label="anchor" href="#arg-input-scale"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a> (<em>optional</em>): defines whether your x-values define wavelength or
energy values. For the analysis an energy scale is expected, allowed values are <code>'wavelength'</code> and
<code>'energy'</code>. If nothing (<code>NULL</code>) is defined, the function tries to understand the input
automatically.</p></dd>


<dt id="arg-method-control">method_control<a class="anchor" aria-label="anchor" href="#arg-method-control"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a> (<em>optional</em>): options to control the fit method, see details</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a> (<em>with default</em>): enable/disable verbose mode</p></dd>


<dt id="arg-plot">plot<a class="anchor" aria-label="anchor" href="#arg-plot"></a></dt>
<dd><p><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a> (<em>with default</em>): enable/disable plot output</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>further arguments to be passed to control the plot output
(supported: <code>main</code>, <code>xlab</code>, <code>ylab</code>, <code>xlim</code>, <code>ylim</code>, <code>log</code>, <code>mtext</code>, <code>legend</code> (<code>TRUE</code> or <code>FALSE</code>),
<code>legend.text</code>, <code>legend.pos</code>)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>———————————–<br><code>[ NUMERICAL OUTPUT ]</code><br>
———————————–<br></p>
<p><strong><code>RLum.Results</code></strong>-object</p>
<p><strong>slot:</strong> <strong><code>@data</code></strong></p>
<table class="table table"><tr><td><strong>Element</strong></td><td><strong>Type</strong></td><td><strong>Description</strong></td></tr><tr><td><code>$data</code></td><td><code>matrix</code></td><td>the final fit matrix</td></tr><tr><td><code>$fit</code></td><td><code>nls</code></td><td>the fit object returned by <a href="https://rdrr.io/pkg/minpack.lm/man/nls.lm.html" class="external-link">minpack.lm::nls.lm</a></td></tr><tr><td><code>$fit_info</code></td><td><code>list</code></td><td>a few additional parameters that can be used to asses the quality
of the fit</td></tr></table><p><strong>slot:</strong> <strong><code>@info</code></strong></p>
<p>The original function call</p>
<p>———————————<br><code>[ TERMINAL OUTPUT ]</code>   <br>
———————————<br></p>
<p>The terminal output provides brief information on the
deconvolution process and the obtained results.
Terminal output is only shown of the argument <code>verbose = TRUE</code>.</p>
<p>—————————<br><code>[ PLOT OUTPUT ]</code>      <br>
—————————<br></p>
<p>The function returns a plot showing the raw signal with the
detected components. If the fitting failed, a basic plot is returned
showing the raw data and indicating the peaks detected for the start
parameter estimation. The grey band in the residual plot indicates the
10% deviation from 0 (means no residual).</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p><strong>Used equation</strong></p>
<p>The emission spectra (on an energy scale) can be best described as the sum of multiple
Gaussian components:</p>
<p>'$$
y = \Sigma  Ci * 1/(\sigma_{i} * \sqrt(2 * \pi)) * exp(-1/2 * ((x - \mu_{i})/\sigma_{i}))^2)
$$</p>
<p>with the parameters \(\sigma\) (peak width) and \(\mu\) (peak centre) and \(C\)
(scaling factor).</p>
<p><strong>Start parameter estimation and fitting algorithm</strong></p>
<p>The spectrum deconvolution consists of the following steps:</p><ol><li><p>Peak finding <br></p></li>
<li><p>Start parameter estimation <br></p></li>
<li><p>Fitting via <a href="https://rdrr.io/pkg/minpack.lm/man/nls.lm.html" class="external-link">minpack.lm::nls.lm</a><br></p></li>
</ol><p>The peak finding is realised by an approach (re-)suggested by Petr Pikal via the R-help
mailing list (<code>https://stat.ethz.ch/pipermail/r-help/2005-November/thread.html</code>) in November 2005.
This goes back to even earlier discussion in 2001 based on Prof Brian Ripley's idea.
It smartly uses the functions <a href="https://rdrr.io/r/stats/embed.html" class="external-link">stats::embed</a> and <a href="https://rdrr.io/r/base/maxCol.html" class="external-link">max.col</a> to identify peaks positions.
For the use in this context, the algorithm has been further modified to scale on the
input data resolution (cf. source code).<br></p>
<p>The start parameter estimation uses random sampling from a range of meaningful parameters
and repeats the fitting until 1000 successful fits have been produced or the set <code>max.runs</code> value
is exceeded.</p>
<p>Currently the best fit is the one with the lowest number for squared residuals, but
other parameters are returned as well. If a series of curves needs to be analysed,
it is recommended to make few trial runs, then fix the number of components and
run  at least 10,000 iterations (parameter <code>method_control = list(max.runs = 10000)</code>).</p>
<p><strong>Supported <code>method_control</code> settings</strong></p>
<table class="table table"><tr><td><strong>Parameter</strong></td><td><strong>Type</strong></td><td><strong>Default</strong></td><td><strong>Description</strong></td></tr><tr><td><code>max.runs</code></td><td><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></td><td><code>10000</code></td><td>maximum allowed search iterations, if exceed
the searching stops</td></tr><tr><td><code>graining</code></td><td><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></td><td><code>15</code></td><td>gives control over how coarse or fine the spectrum is split into search intervals for the peak finding algorithm</td></tr><tr><td><code>norm</code></td><td><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></td><td><code>TRUE</code></td><td>normalises data to the highest count value before fitting</td></tr><tr><td><code>trace</code></td><td><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></td><td><code>FALSE</code></td><td>enables/disables the tracing of the minimisation routine</td></tr></table></div>
    <div class="section level2">
    <h2 id="function-version">Function version<a class="anchor" aria-label="anchor" href="#function-version"></a></h2>
    <p>0.1.1</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><a href="RLum.Data.Spectrum-class.html">RLum.Data.Spectrum</a>, <a href="RLum.Results-class.html">RLum.Results</a>, <a href="plot_RLum.html">plot_RLum</a>,
<a href="convert_Wavelength2Energy.html">convert_Wavelength2Energy</a>, <a href="https://rdrr.io/pkg/minpack.lm/man/nls.lm.html" class="external-link">minpack.lm::nls.lm</a></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Sebastian Kreutzer, Institute of Geography, Heidelberg University (Germany)
, RLum Developer Team</p>
    </div>
    <div class="section level2">
    <h2 id="how-to-cite">How to cite<a class="anchor" aria-label="anchor" href="#how-to-cite"></a></h2>
    <p>Kreutzer, S., 2024. fit_EmissionSpectra(): Luminescence Emission Spectra Deconvolution. Function version 0.1.1. In: Kreutzer, S., Burow, C., Dietze, M., Fuchs, M.C., Schmidt, C., Fischer, M., Friedrich, J., Mercier, N., Philippe, A., Riedesel, S., Autzen, M., Mittelstrass, D., Gray, H.J., Galharret, J., Colombo, M., 2024. Luminescence: Comprehensive Luminescence Dating Data Analysis. R package version 0.9.25. https://r-lum.github.io/Luminescence/</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##load example data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ExampleData.XSYG</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##subtract background</span></span></span>
<span class="r-in"><span><span class="va">TL.Spectrum</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">TL.Spectrum</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="op">]</span> <span class="op">-</span> <span class="va">TL.Spectrum</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="fl">15</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">fit_EmissionSpectra</span><span class="op">(</span></span></span>
<span class="r-in"><span> object <span class="op">=</span> <span class="va">TL.Spectrum</span>,</span></span>
<span class="r-in"><span> frame <span class="op">=</span> <span class="fl">5</span>,</span></span>
<span class="r-in"><span> method_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>max.runs <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [fit_EmissionSpectra()]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &gt;&gt; Treating dataset &gt;&gt; 5 &lt;&lt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &gt;&gt; Wavelength scale detected ...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &gt;&gt; Wavelength to energy scale conversion ... 	[OK]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[/]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			[-]&gt;&gt; Searching components ... 			 [OK]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &gt;&gt; Fitting results (1 component model):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -------------------------------------------------------------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>            mu      SE(mu)     sigma   SE(sigma)         C      SE(C)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,] 2.578405 0.006164145 0.3748431 0.005834923 0.7750861 0.01085102</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -------------------------------------------------------------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> SE: standard error | SSR: 2.164e+01| R^2: 0.807 | R^2_adj: 0.1938</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> (use the output in $fit for a more detailed analysis)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-plt img"><img src="fit_EmissionSpectra-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##deconvolution of a TL spectrum</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##load example data</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">##replace 0 values</span></span></span>
<span class="r-in"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">fit_EmissionSpectra</span><span class="op">(</span></span></span>
<span class="r-in"><span> object <span class="op">=</span> <span class="va">TL.Spectrum</span>,</span></span>
<span class="r-in"><span> frame <span class="op">=</span> <span class="fl">5</span>, main <span class="op">=</span> <span class="st">"TL spectrum"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Kreutzer, Christoph Burow, Michael Dietze, Margret C. Fuchs, Christoph Schmidt, Manfred Fischer, Johannes Friedrich, Norbert Mercier, Anne Philippe, Svenja Riedesel, Martin Autzen, Dirk Mittelstrass, Harrison J. Gray, Jean-Michel Galharret, Marco Colombo.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

