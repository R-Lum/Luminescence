---
output: github_document
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
---
<!-- NEWS.md was auto-generated by NEWS.Rmd. Please DO NOT edit by hand!-->

# Changes in version `r RLumBuild::.get_pkg_version()` (`r Sys.Date()`)

## New functions

* `melt_RLum()`: Creates a new flat `data.frame` from the objects that can be
used for instance in combination with `'ggplot2'`. Works only on `RLum.Data.Curve-class`
and `RLum.Analysis-class` objects and lists of such objects.

## Breaking changes
* We have dropped our dependency on the `readxl` package: functions
`analyse_baSAR()` and `use_DRAC()` now do not accept XLS files anymore but
CSV files instead (#237, fixed in #270). CSV files can be easily generated
from XLS files by Excel or similar applications, or by reading them with
`readxl::read_excel()` and saving them with `write.csv()`.

## Removed functions and deprecations
* Function `Analyse_SAR.OSLdata()` is now officially deprecated,
`analyse_SAR.CWOSL()` should be used instead (#216, fixed in #264).

* Function `calc_Kars2008()` (deprecated since version 0.8.1) is now officially defunct,
`calc_Huntley2006()` should be used instead (#252, fixed in #257).

## Bugfixes

### `analyse_baSAR()`
* Argument `XLS_file` has been replaced by `CSV_file` and, as mentioned
above, the function now only accepts CSV files as input (#237, fixed in #270).

### `analyse_FadingMeasurement()`
* The function now checks for the version of the BIN-file that originated the
`RLum.Analysis` given as input, and reports a message if a version older than
5 was used (#281, fixed in #282).
* The function doesn't crash anymore on some `RLum.Analysis` input files
(#283, fixed in #288).

### `analyse_pIRIRSequence()`
* The function crashed with a object merge error if run in a loop because of a `merge_RLum()` error. This
was caused by a regression while implementing the `n_N` calculation in `plot_GrowthCurve()`. Potentially
affected was also `analyse_SAR.CWOSL()`.
* The function now shows a warning and sets `plot = FALSE` when option
`plot.single = TRUE` is set but the device size is too small. This should
prevent "Figure margins too large" errors.
* The function will not crash anymore during the plotting in another edge case related to single grain data. 

### `analyse_SAR.TL()`
* The function now produces a more correct `rejection.criteria` data frame
(#245, fixed in #246).
* Several edge cases that led to crashes have been fixed (#147, fixed in #247).

### `calc_CentralDose()`
* Argument `na.rm` is now deprecated: the function will now always remove
missing values, as otherwise the presence of any `NA` would propagate and
produce unusable results (all `NA`s) or buggy behaviour (#302, fixed in #304).
* The function stops the fixed-point iteration for the computation of the
profile log-likelihood as soon as `sigma < 1e-16`, as allowing `sigma` to
become zero leads to infinities and buggy behaviour (also fixed in #304).

### `calc_Lamothe2003()`
* We addressed a long-standing issue (#96) regarding the calculation of the
calculation of the `Ln/Tn` error after fading correction, which led to smaller
than expected errors (fixed in #296).

### `get_RLum()`
* When the function was used on a list of `RLum.Analysis-class` objects with the argument `null.rm = TRUE` it would 
remove all `NULL` objects, but not elements that became `list()` (empty list) during the selection; fixed.
* Fix an edge case that caused a rather non-expected, more visible output problem. When curves were selected via
`recordType` on `RLum.Analysis-class` objects (or a list of them) and the object contained only a single `RLum.Data-class` object, 
the function returned the `RLum.Data.Curve-class` object *regardless* of the selection in `recordType`. In other words: 
If a user tried `recordType = "TL"` on an `RLum.Analysis-class` object that contained only a single IRSL curve, the
function would still return that single IRSL curve instead of an empty element. The reason for this behaviour was a poor attempt to deal with `NA` in the `recordType` name that led to missing values and unexpected behaviour for a logical comparison. Now, before the subset happens, `NA` values in `recordType` are converted to `"NA"` (a character) and the wiggling around that was causing the lousy subsetting was removed. 

### `plot_RLum.Data.Curve()`
* Argument `norm` is now better validated so that specifying an incorrect
value returns an error instead of silently skip curve normalisation (#250,
fixed in #263).

### `plot_RLum.Data.Spectrum()`
* Add support for `lphi` and `ltheta` light direction arguments for `plot.type = "persp"`. 
* Fix the reason for the unclear warning `In col.unique == col :  longer object length is not a multiple of shorter object length`

### `read_XSYG2R()`
* Add a new argument `n_records` that enables to limit the number of imported records in case the file was faulty or only a limited number of records is wanted.  
* The function sometimes struggled with the import if only a directory was provided; fixed. 
* The function truncated the terminal output under certain circumstances; fixed.

### `use_DRAC()`
* Support for DRAC v1.1 XLS/XLSX files has been dropped, users should use
CSV files according to the DRAC v1.2 CSV template.

### `write_R2BIN()`
* Recently, non-ASCII characters in comments or file names became more common and that led to crashes during the 
file export. To avoid this now all non-ASCII characters are replaced by `_` before writing them to the BIN/BINX files. 
* The function now returns the file path of the export. 
* Fix a bug that left connections open if the function crashed. 

## Internals

* Two new internal functions `.throw_warning()` and `.throw_error()` sometimes flushed the
terminal with messages if call (internally) in particular circumstances. Now we maintain a
stack of function names, so that at any time we can report correctly the name of the
function where an error or a warning is thrown (#254, fixed in #256).
